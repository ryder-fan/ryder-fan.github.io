// @ts-nocheck
"use strict";console.warn=function(...t){console.log("[WARNING]",...t),Dialog.warning("警告",t.join(" "))},console.error=function(...t){console.log("[ERROR]",...t),Dialog.error("错误",t.join(" "))};class Dialog{static info(t,e){Swal.fire(t,e,"info")}static success(t,e){Swal.fire(t,e,"success")}static error(t,e){Swal.fire(t,e,"error")}static warning(t,e){Swal.fire(t,e,"warning")}static confirm(t,e,s){Swal.fire({title:t,text:e,icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"确定",cancelButtonText:"取消"}).then((t=>{t.isConfirmed?s(!0):s(!1)}))}}class ImgManager{static#t={"CC-B":"img/CC-B.png","CC-C":"img/CC-C.png","CC-M":"img/CC-M.png","CC-P":"img/CC-P.png","CC-S":"img/CC-S.png","CC-W":"img/CC-W.png","CC-X":"img/CC-X.png","IC-B":"img/IC-B.png","IC-K":"img/IC-K.png","IC-N":"img/IC-N.png","IC-Q":"img/IC-Q.png","IC-R":"img/IC-R.png","IC-S":"img/IC-S.png","chosen-r":"img/chosen-r.png","chosen-b":"img/chosen-b.png","chosen-y":"img/chosen-y.png",background:"img/background.png"};constructor(){}static getImg(t){return this.#t[t]?this.#t[t]:""}static async loadImgs(t){let e=Date.now();console.log("Start load imgs...");const s=document.querySelector("#loader-container"),i=document.querySelector("#loadingtext"),o=document.querySelector("#loadingimg");let a,C=0,n=Object.keys(this.#t).length;for(let t in this.#t)o.src=this.#t[t],o.onload=function(){C++,i.textContent="Loading ("+C+"/"+n+") ...",a()},o.onerror=function(){console.warn("error load img: "+t),C++,i.textContent="Loading ("+C+"/"+n+") ...",a()},await new Promise((t=>a=t));s.parentNode&&s.parentNode.removeChild(s),console.log("Load imgs done, time: "+(Date.now()-e)+"ms"),t&&setTimeout(t,100)}}class GameManager{static size;static#e;static#s;static#i;static#o;static#a;static#C;static player_color={CC:"红方",IC:"黑方"};static player_turn;static chessMap={"CC-B1":{x:2,y:7,type:"CC-B",color:"CC",img:ImgManager.getImg("CC-B")},"CC-B2":{x:3,y:7,type:"CC-B",color:"CC",img:ImgManager.getImg("CC-B")},"CC-B3":{x:4,y:7,type:"CC-B",color:"CC",img:ImgManager.getImg("CC-B")},"CC-B4":{x:6,y:7,type:"CC-B",color:"CC",img:ImgManager.getImg("CC-B")},"CC-B5":{x:7,y:7,type:"CC-B",color:"CC",img:ImgManager.getImg("CC-B")},"CC-C1":{x:1,y:7,type:"CC-C",color:"CC",img:ImgManager.getImg("CC-C")},"CC-C2":{x:8,y:7,type:"CC-C",color:"CC",img:ImgManager.getImg("CC-C")},"CC-M1":{x:2,y:8,type:"CC-M",color:"CC",img:ImgManager.getImg("CC-M")},"CC-M2":{x:7,y:8,type:"CC-M",color:"CC",img:ImgManager.getImg("CC-M")},"CC-P1":{x:1,y:8,type:"CC-P",color:"CC",img:ImgManager.getImg("CC-P")},"CC-P2":{x:8,y:8,type:"CC-P",color:"CC",img:ImgManager.getImg("CC-P")},"CC-S1":{x:5,y:7,type:"CC-S",color:"CC",img:ImgManager.getImg("CC-S")},"CC-S2":{x:5,y:8,type:"CC-S",color:"CC",img:ImgManager.getImg("CC-S")},"CC-W":{x:4,y:8,type:"CC-W",color:"CC",img:ImgManager.getImg("CC-W")},"CC-X1":{x:3,y:8,type:"CC-X",color:"CC",img:ImgManager.getImg("CC-X")},"CC-X2":{x:6,y:8,type:"CC-X",color:"CC",img:ImgManager.getImg("CC-X")},"IC-B1":{x:3,y:1,type:"IC-B",color:"IC",img:ImgManager.getImg("IC-B")},"IC-B2":{x:6,y:1,type:"IC-B",color:"IC",img:ImgManager.getImg("IC-B")},"IC-K":{x:4,y:1,type:"IC-K",color:"IC",img:ImgManager.getImg("IC-K")},"IC-N1":{x:2,y:1,type:"IC-N",color:"IC",img:ImgManager.getImg("IC-N")},"IC-N2":{x:7,y:1,type:"IC-N",color:"IC",img:ImgManager.getImg("IC-N")},"IC-Q":{x:5,y:1,type:"IC-Q",color:"IC",img:ImgManager.getImg("IC-Q")},"IC-R1":{x:1,y:1,type:"IC-R",color:"IC",img:ImgManager.getImg("IC-R")},"IC-R2":{x:8,y:1,type:"IC-R",color:"IC",img:ImgManager.getImg("IC-R")},"IC-S1":{x:1,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S2":{x:2,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S3":{x:3,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S4":{x:4,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S5":{x:5,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S6":{x:6,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S7":{x:7,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S8":{x:8,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")}};static ChessManagers={"CC-B1":void 0,"CC-B2":void 0,"CC-B3":void 0,"CC-B4":void 0,"CC-B5":void 0,"CC-C1":void 0,"CC-C2":void 0,"CC-M1":void 0,"CC-M2":void 0,"CC-P1":void 0,"CC-P2":void 0,"CC-S1":void 0,"CC-S2":void 0,"CC-W":void 0,"CC-X1":void 0,"CC-X2":void 0,"IC-B1":void 0,"IC-B2":void 0,"IC-K":void 0,"IC-N1":void 0,"IC-N2":void 0,"IC-Q":void 0,"IC-R1":void 0,"IC-R2":void 0,"IC-S1":void 0,"IC-S2":void 0,"IC-S3":void 0,"IC-S4":void 0,"IC-S5":void 0,"IC-S6":void 0,"IC-S7":void 0,"IC-S8":void 0};static#n=[];static movingChess;static setup(){this.#e=document.getElementById("board"),this.#s=document.getElementById("board-img"),this.#i=document.getElementById("move-from"),this.#o=document.getElementById("move-to"),this.#a=document.getElementById("chosen"),this.#C=document.getElementById("player-turn"),document.getElementById("export-btn").addEventListener("click",this.export.bind(this)),this.setupBoard(),this.setSize()}static setSize(){this.size=Math.min(window.innerWidth,window.innerHeight),window.innerWidth>=window.innerHeight?document.body.className="horizontal":document.body.className="vertical",this.#e.style.width=.8*this.size+"px",this.#e.style.height=.8*this.size+"px"}static setupBoard(){this.#e.addEventListener("click",this.boardClicked.bind(this)),this.#s.src=ImgManager.getImg("background"),this.#i.src=ImgManager.getImg("chosen-y"),this.#o.src=ImgManager.getImg("chosen-y"),this.#a.src=ImgManager.getImg("chosen-b");for(let t=1;t<=8;t++)for(let e=1;e<=8;e++){let s=document.createElement("img");s.src=ImgManager.getImg("chosen-r"),s.alt="move to here",s.classList.add("selectBox"),s.style.position="absolute",s.style.left=12.5*(t-1)+"%",s.style.top=12.5*(e-1)+"%",s.style.display="none",s.style.pointerEvents="none",this.#e.appendChild(s),this.#n.push({x:t,y:e,node:s})}let t;window.location.search.startsWith("?data=")&&(t=JSON.parse(decodeURIComponent(window.location.search.slice(6))));for(const e in this.chessMap)this.ChessManagers[e]=new ChessManager(e),t&&t[e]&&(this.ChessManagers[e].setPos(t[e].x,t[e].y),this.ChessManagers[e].moved=t[e].m);t&&t.p?this.player_turn=t.p:this.player_turn="CC",this.#C.textContent=`${this.player_color[this.player_turn]}`}static choose(t,e){this.#a.style.display="block",this.#a.style.left=12.5*(t-1)+"%",this.#a.style.top=12.5*(e-1)+"%"}static canMoveTipNode(t,e){for(let s of this.#n)s.x==t&&s.y==e&&(s.node.style.display="block")}static unChooseAll(){for(let t of this.#n)t.node.style.display="none";this.#a.style.display="none";for(const t in this.ChessManagers)"chosen"==this.ChessManagers[t].status&&this.ChessManagers[t].unChoose();this.movingChess=void 0}static getChessByPos(t,e){for(const s in this.chessMap){const i=this.ChessManagers[s];if(i.posx==t&&i.posy==e)return i}}static boardClicked(t){const e=Math.floor(t.offsetX/(.8*this.size/8))+1,s=Math.floor(t.offsetY/(.8*this.size/8))+1,i=this.getChessByPos(e,s);if(i)""==i.status?i.id.startsWith(this.player_turn)?(this.unChooseAll(),i.choose()):this.movingChess?this.movingChess.moveTo(e,s):Dialog.error("不是你的回合",`现在为${this.player_color[this.player_turn]}走棋`):"chosen"==i.status&&this.unChooseAll();else{if(!this.movingChess)return;this.movingChess.moveTo(e,s)}}static nextRound(t,e,s,i){"CC"==this.player_turn?this.player_turn="IC":this.player_turn="CC",this.#C.textContent=`${this.player_color[this.player_turn]}`,this.#i.style.display="block",this.#i.style.left=12.5*(t-1)+"%",this.#i.style.top=12.5*(e-1)+"%",this.#o.style.display="block",this.#o.style.left=12.5*(s-1)+"%",this.#o.style.top=12.5*(i-1)+"%",this.unChooseAll()}static export(){const t={};t.p=this.player_turn;for(const e in this.ChessManagers){const s=this.ChessManagers[e];t[e]={x:"eaten"==s.status?-1:s.posx,y:"eaten"==s.status?-1:s.posy,m:s.moved?1:0}}const e=window.location.href.split("?")[0]+"?data="+JSON.stringify(t);window.location.href=e}}class ChessManager{chessMap=GameManager.chessMap;#r;#e;id;type;moved=!1;status="";posx;posy;constructor(t){this.#e=document.getElementById("board"),this.id=t,this.type=this.chessMap[t].type,this.createChess(t)}unChoose(){GameManager.movingChess==this&&(GameManager.movingChess=void 0),this.status=""}choose(){GameManager.movingChess=this,this.status="chosen",GameManager.choose(this.posx,this.posy);let t=MoveManager.canMovePosList(this);console.log(t);for(let e of t)GameManager.canMoveTipNode(e[0],e[1])}createChess(){this.#r=document.createElement("div"),this.#r.id=this.id,this.#r.classList.add("chess");const t=document.createElement("img");t.id=this.id+"-img",t.src=this.chessMap[this.id].img,t.alt=this.id,this.#r.appendChild(t),this.#e.appendChild(this.#r),this.setPos(this.chessMap[this.id].x,this.chessMap[this.id].y)}setPos(t,e){[1,2,3,4,5,6,7,8].includes(t)&&[1,2,3,4,5,6,7,8].includes(e)?(this.posx=t,this.posy=e,this.#r.style.left=12.5*(t-1)+"%",this.#r.style.top=12.5*(e-1)+"%"):-1==t&&-1==e?(this.status="eaten",this.posx=-1,this.posy=-1,this.#r.parentNode&&this.#r.parentNode.removeChild(this.#r)):console.warn(`Invalid position: (${t}, ${e}), Chess: ${this.id}`)}canMoveTo(t,e){if(![1,2,3,4,5,6,7,8].includes(t)||![1,2,3,4,5,6,7,8].includes(e))return!1;for(let s of MoveManager.canMovePosList(this))if(s[0]==t&&s[1]==e)return!0;return!1}moveTo(t,e){if("chosen"!=this.status)return GameManager.unChooseAll();if([1,2,3,4,5,6,7,8].includes(t)&&[1,2,3,4,5,6,7,8].includes(e)){if(!this.canMoveTo(t,e))return Dialog.warning("移动失败",`${this.id}不能从(${this.posx}, ${this.posy})移动到(${t}, ${e})`);if(GameManager.getChessByPos(t,e)){const s=GameManager.getChessByPos(t,e);s.setPos(-1,-1),"IC-K"==s.id&&Dialog.success("胜利","红方获胜"),"CC-W"==s.id&&Dialog.success("胜利","黑方获胜")}this.moved=!0,GameManager.nextRound(this.posx,this.posy,t,e),this.setPos(t,e)}}}class MoveManager{static isEmpty(t,e){return!GameManager.getChessByPos(t,e)}static canEat(t,e,s){if(this.isEmpty(t,e))return!0;return GameManager.getChessByPos(t,e).id.slice(0,2)!=s}static isBlock(t,e){return(1==t||8==t)&&6==e}static canMovePosList(t){const e=t.posx,s=t.posy;if(t.id.startsWith("CC")&&this.isBlock(e,s))return[];switch(t.type){case"CC-B":return this.moveCCB(e,s);case"CC-C":return this.moveCCC(e,s);case"CC-M":return this.moveCCM(e,s);case"CC-P":return this.moveCCP(e,s);case"CC-S":return this.moveCCS(e,s);case"CC-W":return this.moveCCW(e,s);case"CC-X":return this.moveCCX(e,s);case"IC-B":return this.moveICB(e,s);case"IC-K":return this.moveICK(e,s);case"IC-N":return this.moveICN(e,s);case"IC-Q":return this.moveICQ(e,s);case"IC-R":return this.moveICR(e,s);case"IC-S":return this.moveICS(e,s)}return[]}static moveCCB(t,e){let s=[];return this.canEat(t,e-1,"CC")&&s.push([t,e-1]),e<=4&&this.canEat(t-1,e,"CC")&&s.push([t-1,e]),e<=4&&this.canEat(t+1,e,"CC")&&s.push([t+1,e]),s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCC(t,e){let s=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1]])for(let o=1;o<=8;o++){let a=t+i[0]*o,C=e+i[1]*o;if(a<1||a>8||C<1||C>8)break;if(this.isBlock(a,C)&&this.canEat(a,C,"CC")){s.push([a,C]);break}if(!this.isEmpty(a,C)){this.canEat(a,C,"CC")&&s.push([a,C]);break}s.push([a,C])}return s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCM(t,e){let s=[];return this.isEmpty(t,e-1)&&this.canEat(t+1,e-2,"CC")&&s.push([t+1,e-2]),this.isEmpty(t,e-1)&&this.canEat(t-1,e-2,"CC")&&s.push([t-1,e-2]),this.isEmpty(t+1,e)&&this.canEat(t+2,e-1,"CC")&&s.push([t+2,e-1]),this.isEmpty(t-1,e)&&this.canEat(t-2,e-1,"CC")&&s.push([t-2,e-1]),this.isEmpty(t,e+1)&&this.canEat(t+1,e+2,"CC")&&s.push([t+1,e+2]),this.isEmpty(t,e+1)&&this.canEat(t-1,e+2,"CC")&&s.push([t-1,e+2]),this.isEmpty(t+1,e)&&this.canEat(t+2,e+1,"CC")&&s.push([t+2,e+1]),this.isEmpty(t-1,e)&&this.canEat(t-2,e+1,"CC")&&s.push([t-2,e+1]),s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCP(t,e){let s=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1]])for(let o=1;o<=8;o++){let a=t+i[0]*o,C=e+i[1]*o;if(a<1||a>8||C<1||C>8)break;if(this.isBlock(a,C)&&this.isEmpty(a,C)){s.push([a,C]);break}if(!this.isEmpty(a,C))break;s.push([a,C])}for(let i=1;i<=8;i++)for(let o=1;o<=8;o++){if(this.isEmpty(i,o))continue;if(!this.canEat(i,o,"CC"))continue;let a=GameManager.getChessByPos(i,o),C=Math.min(t,i),n=Math.max(t,i),r=Math.min(e,o),h=Math.max(e,o),g=0;if(i==t){for(let e=r+1;e<h;e++)1!=t&&8!=t||6!=e||(g=1/0),this.isEmpty(i,e)||g++;1==g&&s.push([i,o])}if(o==e){for(let t=C+1;t<n;t++)this.isEmpty(t,o)||g++;1==g&&s.push([i,o])}if(i!=t&&o!=e){if(!a.moved)continue;let r=(o-e)/(i-t),h=e-r*t;for(let t=C+1;t<n;t++){if(!Number.isInteger(r*t+h))continue;let e=r*t+h;this.isEmpty(t,e)||g++}1==g&&s.push([i,o])}}return s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCS(t,e){let s=[];for(let i of[[-1,-1],[-1,1],[1,-1],[1,1]])this.canEat(t+i[0],e+i[1],"CC")&&s.push([t+i[0],e+i[1]]);return s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCW(t,e){let s=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]])this.canEat(t+i[0],e+i[1],"CC")&&s.push([t+i[0],e+i[1]]);return s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCX(t,e){let s=[];for(let i of[[-1,-1],[-1,1],[1,-1],[1,1]])for(let o=1;o<=3;o++)1!=o?this.isEmpty(t+i[0]*(o-1),e+i[1]*(o-1))&&this.canEat(t+i[0]*o,e+i[1]*o,"CC")&&s.push([t+i[0]*o,e+i[1]*o]):this.canEat(t+i[0],e+i[1],"CC")&&s.push([t+i[0],e+i[1]]);return s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICB(t,e){let s=[];for(let i of[[-1,-1],[-1,1],[1,-1],[1,1]])for(let o=1;o<=8;o++){let a=t+i[0]*o,C=e+i[1]*o;if(a<1||a>8||C<1||C>8)break;if(this.isBlock(a,C)&&this.canEat(a,C,"IC")){s.push([a,C]);break}if(!this.isEmpty(a,C)){this.canEat(a,C,"IC")&&s.push([a,C]);break}s.push([a,C])}return s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICK(t,e){let s=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]])this.canEat(t+i[0],e+i[1],"IC")&&s.push([t+i[0],e+i[1]]);return s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICN(t,e){let s=[];for(let i of[[-1,-2],[-2,-1],[-2,1],[-1,2],[1,-2],[2,-1],[2,1],[1,2]])this.canEat(t+i[0],e+i[1],"IC")&&s.push([t+i[0],e+i[1]]);return s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICQ(t,e){let s=[];for(let i of[[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1]])for(let o=1;o<=8;o++){let a=t+i[0]*o,C=e+i[1]*o;if(a<1||a>8||C<1||C>8)break;if(this.isBlock(a,C)){this.canEat(a,C,"IC")&&s.push([a,C]);break}if(!this.isEmpty(a,C)){this.canEat(a,C,"IC")&&s.push([a,C]);break}s.push([a,C])}return s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICR(t,e){let s=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1]])for(let o=1;o<=8;o++){let a=t+i[0]*o,C=e+i[1]*o;if(a<1||a>8||C<1||C>8)break;if(this.isBlock(a,C)){this.canEat(a,C,"IC")&&s.push([a,C]);break}if(!this.isEmpty(a,C)){this.canEat(a,C,"IC")&&s.push([a,C]);break}s.push([a,C])}return s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICS(t,e){let s=[];return this.isEmpty(t,e+1)&&s.push([t,e+1]),!this.isEmpty(t-1,e+1)&&this.canEat(t-1,e+1,"IC")&&s.push([t-1,e+1]),!this.isEmpty(t+1,e+1)&&this.canEat(t+1,e+1,"IC")&&s.push([t+1,e+1]),2==e&&this.isEmpty(t,e+1)&&this.isEmpty(t,e+2)&&s.push([t,e+2]),s.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}}document.addEventListener("DOMContentLoaded",(()=>ImgManager.loadImgs(GameManager.setup.bind(GameManager)))),window.addEventListener("resize",GameManager.setSize.bind(GameManager));