// @ts-nocheck
"use strict";console.warn=function(...e){console.log("[WARNING]",...e),Dialog.warning("警告",e.join(" "))},console.error=function(...e){console.log("[ERROR]",...e),Dialog.error("错误",e.join(" "))};class Dialog{static info(e,t){Swal.fire(e,t,"info")}static success(e,t){Swal.fire(e,t,"success")}static error(e,t){Swal.fire(e,t,"error")}static warning(e,t){Swal.fire(e,t,"warning")}static confirm(e,t,s){Swal.fire({title:e,text:t,icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"确定",cancelButtonText:"取消"}).then((e=>{e.isConfirmed?s(!0):s(!1)}))}}class ImgManager{static#e={"CC-B":"img/CC-B.png","CC-C":"img/CC-C.png","CC-M":"img/CC-M.png","CC-P":"img/CC-P.png","CC-S":"img/CC-S.png","CC-W":"img/CC-W.png","CC-X":"img/CC-X.png","IC-B":"img/IC-B.png","IC-K":"img/IC-K.png","IC-N":"img/IC-N.png","IC-Q":"img/IC-Q.png","IC-R":"img/IC-R.png","IC-S":"img/IC-S.png","chosen-r":"img/chosen-r.png","chosen-b":"img/chosen-b.png","chosen-y":"img/chosen-y.png",background:"img/background.png"};constructor(){}static getImg(e){return this.#e[e]?this.#e[e]:""}static async loadImgs(e){let t=Date.now();console.log("Start load imgs...");const s=document.querySelector("#loader-container"),i=document.querySelector("#loadingtext"),o=document.querySelector("#loadingimg");let C,a=0,n=Object.keys(this.#e).length;for(let e in this.#e)o.src=this.#e[e],o.onload=function(){a++,i.textContent="Loading ("+a+"/"+n+") ...",C()},o.onerror=function(){console.warn("error load img: "+e),a++,i.textContent="Loading ("+a+"/"+n+") ...",C()},await new Promise((e=>C=e));s.parentNode&&s.parentNode.removeChild(s),console.log("Load imgs done, time: "+(Date.now()-t)+"ms"),e&&e()}}class GameManager{static size;static#t;static#s;static#i;static#o;static#C;static#a;static player_color={CC:"红方",IC:"黑方"};static player_turn;static chessMap={"CC-B1":{x:2,y:7,type:"CC-B",color:"CC",img:ImgManager.getImg("CC-B")},"CC-B2":{x:3,y:7,type:"CC-B",color:"CC",img:ImgManager.getImg("CC-B")},"CC-B3":{x:4,y:7,type:"CC-B",color:"CC",img:ImgManager.getImg("CC-B")},"CC-B4":{x:6,y:7,type:"CC-B",color:"CC",img:ImgManager.getImg("CC-B")},"CC-B5":{x:7,y:7,type:"CC-B",color:"CC",img:ImgManager.getImg("CC-B")},"CC-C1":{x:1,y:7,type:"CC-C",color:"CC",img:ImgManager.getImg("CC-C")},"CC-C2":{x:8,y:7,type:"CC-C",color:"CC",img:ImgManager.getImg("CC-C")},"CC-M1":{x:2,y:8,type:"CC-M",color:"CC",img:ImgManager.getImg("CC-M")},"CC-M2":{x:7,y:8,type:"CC-M",color:"CC",img:ImgManager.getImg("CC-M")},"CC-P1":{x:1,y:8,type:"CC-P",color:"CC",img:ImgManager.getImg("CC-P")},"CC-P2":{x:8,y:8,type:"CC-P",color:"CC",img:ImgManager.getImg("CC-P")},"CC-S1":{x:5,y:7,type:"CC-S",color:"CC",img:ImgManager.getImg("CC-S")},"CC-S2":{x:5,y:8,type:"CC-S",color:"CC",img:ImgManager.getImg("CC-S")},"CC-W":{x:4,y:8,type:"CC-W",color:"CC",img:ImgManager.getImg("CC-W")},"CC-X1":{x:3,y:8,type:"CC-X",color:"CC",img:ImgManager.getImg("CC-X")},"CC-X2":{x:6,y:8,type:"CC-X",color:"CC",img:ImgManager.getImg("CC-X")},"IC-B1":{x:3,y:1,type:"IC-B",color:"IC",img:ImgManager.getImg("IC-B")},"IC-B2":{x:6,y:1,type:"IC-B",color:"IC",img:ImgManager.getImg("IC-B")},"IC-K":{x:4,y:1,type:"IC-K",color:"IC",img:ImgManager.getImg("IC-K")},"IC-N1":{x:2,y:1,type:"IC-N",color:"IC",img:ImgManager.getImg("IC-N")},"IC-N2":{x:7,y:1,type:"IC-N",color:"IC",img:ImgManager.getImg("IC-N")},"IC-Q":{x:5,y:1,type:"IC-Q",color:"IC",img:ImgManager.getImg("IC-Q")},"IC-R1":{x:1,y:1,type:"IC-R",color:"IC",img:ImgManager.getImg("IC-R")},"IC-R2":{x:8,y:1,type:"IC-R",color:"IC",img:ImgManager.getImg("IC-R")},"IC-S1":{x:1,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S2":{x:2,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S3":{x:3,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S4":{x:4,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S5":{x:5,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S6":{x:6,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S7":{x:7,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")},"IC-S8":{x:8,y:2,type:"IC-S",color:"IC",img:ImgManager.getImg("IC-S")}};static ChessManagers={"CC-B1":void 0,"CC-B2":void 0,"CC-B3":void 0,"CC-B4":void 0,"CC-B5":void 0,"CC-C1":void 0,"CC-C2":void 0,"CC-M1":void 0,"CC-M2":void 0,"CC-P1":void 0,"CC-P2":void 0,"CC-S1":void 0,"CC-S2":void 0,"CC-W":void 0,"CC-X1":void 0,"CC-X2":void 0,"IC-B1":void 0,"IC-B2":void 0,"IC-K":void 0,"IC-N1":void 0,"IC-N2":void 0,"IC-Q":void 0,"IC-R1":void 0,"IC-R2":void 0,"IC-S1":void 0,"IC-S2":void 0,"IC-S3":void 0,"IC-S4":void 0,"IC-S5":void 0,"IC-S6":void 0,"IC-S7":void 0,"IC-S8":void 0};static movingChess;static setup(){this.#t=document.getElementById("board"),this.#s=document.getElementById("board-img"),this.#i=document.getElementById("move-from"),this.#o=document.getElementById("move-to"),this.#C=document.getElementById("chosen"),this.#a=document.getElementById("player-turn"),this.setupBoard(),this.setSize()}static setSize(){this.size=Math.min(window.innerWidth,window.innerHeight),window.innerWidth>=window.innerHeight?document.body.className="horizontal":document.body.className="vertical",this.#t.style.width=.8*this.size+"px",this.#t.style.height=.8*this.size+"px"}static setupBoard(){this.#t.addEventListener("click",this.boardClicked.bind(this)),this.#s.src=ImgManager.getImg("background"),this.#i.src=ImgManager.getImg("chosen-y"),this.#o.src=ImgManager.getImg("chosen-y"),this.#C.src=ImgManager.getImg("chosen-b");for(const e in this.chessMap)this.ChessManagers[e]=new ChessManager(e);this.player_turn="CC",this.#a.textContent=`${this.player_color[this.player_turn]}`}static choose(e,t){this.#C.style.display="block",this.#C.style.left=12.5*(e-1)+"%",this.#C.style.top=12.5*(t-1)+"%"}static canMoveTipNode(e,t){let s=document.createElement("img");s.id="canMovePos",s.src=ImgManager.getImg("chosen-r"),s.alt="canMovePos",s.classList.add("selectBox"),s.style.left=12.5*(e-1)+"%",s.style.top=12.5*(t-1)+"%",s.style.display="block",this.#t.appendChild(s)}static unChooseAll(){document.querySelectorAll("#canMovePos").forEach((e=>e.remove())),this.#C.style.display="none";for(const e in this.ChessManagers)"chosen"==this.ChessManagers[e].status&&this.ChessManagers[e].unChoose();this.movingChess=void 0}static getChessByPos(e,t){for(const s in this.chessMap){const i=this.ChessManagers[s];if(i.posx==e&&i.posy==t)return i}}static boardClicked(e){const t=Math.floor(e.offsetX/(.8*this.size/8))+1,s=Math.floor(e.offsetY/(.8*this.size/8))+1,i=this.getChessByPos(t,s);if(i)""==i.status?i.id.startsWith(this.player_turn)?(this.unChooseAll(),i.choose()):this.movingChess?this.movingChess.moveTo(t,s):Dialog.error("不是你的回合",`现在为${this.player_color[this.player_turn]}走棋`):"chosen"==i.status&&this.unChooseAll();else{if(!this.movingChess)return;this.movingChess.moveTo(t,s)}}static nextRound(e,t,s,i){"CC"==this.player_turn?this.player_turn="IC":this.player_turn="CC",this.#a.textContent=`${this.player_color[this.player_turn]}`,this.#i.style.display="block",this.#i.style.left=12.5*(e-1)+"%",this.#i.style.top=12.5*(t-1)+"%",this.#o.style.display="block",this.#o.style.left=12.5*(s-1)+"%",this.#o.style.top=12.5*(i-1)+"%",this.unChooseAll()}}class ChessManager{chessMap=GameManager.chessMap;#n;#t;id;type;moved=!1;status="";posx;posy;constructor(e){this.#t=document.getElementById("board"),this.id=e,this.type=this.chessMap[e].type,this.createChess(e)}unChoose(){GameManager.movingChess==this&&(GameManager.movingChess=void 0),this.status=""}choose(){GameManager.movingChess=this,this.status="chosen",GameManager.choose(this.posx,this.posy);let e=MoveManager.canMovePosList(this);console.log(e);for(let t of e)GameManager.canMoveTipNode(t[0],t[1])}createChess(){this.#n=document.createElement("div"),this.#n.id=this.id,this.#n.classList.add("chess");const e=document.createElement("img");e.id=this.id+"-img",e.src=this.chessMap[this.id].img,e.alt=this.id,this.#n.appendChild(e),this.#t.appendChild(this.#n),this.setPos(this.chessMap[this.id].x,this.chessMap[this.id].y)}setPos(e,t){[1,2,3,4,5,6,7,8].includes(e)&&[1,2,3,4,5,6,7,8].includes(t)?(this.posx=e,this.posy=t,this.#n.style.left=12.5*(e-1)+"%",this.#n.style.top=12.5*(t-1)+"%"):-1==e&&-1==t?(this.posx=-1,this.posy=-1,this.#n.parentNode&&this.#n.parentNode.removeChild(this.#n)):console.warn(`Invalid position: (${e}, ${t}), Chess: ${this.id}`)}canMoveTo(e,t){if(![1,2,3,4,5,6,7,8].includes(e)||![1,2,3,4,5,6,7,8].includes(t))return!1;for(let s of MoveManager.canMovePosList(this))if(s[0]==e&&s[1]==t)return!0;return!1}moveTo(e,t){if("chosen"!=this.status)return GameManager.unChooseAll();if([1,2,3,4,5,6,7,8].includes(e)&&[1,2,3,4,5,6,7,8].includes(t)){if(!this.canMoveTo(e,t))return Dialog.warning("移动失败",`${this.id}不能从(${this.posx}, ${this.posy})移动到(${e}, ${t})`);if(GameManager.getChessByPos(e,t)){const s=GameManager.getChessByPos(e,t);s.status="eaten",s.setPos(-1,-1)}this.moved=!0,GameManager.nextRound(this.posx,this.posy,e,t),this.setPos(e,t)}}}class MoveManager{static isEmpty(e,t){return!GameManager.getChessByPos(e,t)}static canEat(e,t,s){if(this.isEmpty(e,t))return!0;return GameManager.getChessByPos(e,t).id.slice(0,2)!=s}static isBlock(e,t){return(1==e||8==e)&&6==t}static canMovePosList(e){const t=e.posx,s=e.posy;if(e.id.startsWith("CC")&&this.isBlock(t,s))return[];switch(e.type){case"CC-B":return this.moveCCB(t,s);case"CC-C":return this.moveCCC(t,s);case"CC-M":return this.moveCCM(t,s);case"CC-P":return this.moveCCP(t,s);case"CC-S":return this.moveCCS(t,s);case"CC-W":return this.moveCCW(t,s);case"CC-X":return this.moveCCX(t,s);case"IC-B":return this.moveICB(t,s);case"IC-K":return this.moveICK(t,s);case"IC-N":return this.moveICN(t,s);case"IC-Q":return this.moveICQ(t,s);case"IC-R":return this.moveICR(t,s);case"IC-S":return this.moveICS(t,s)}return[]}static moveCCB(e,t){let s=[];return this.canEat(e,t-1,"CC")&&s.push([e,t-1]),t<=4&&this.canEat(e-1,t,"CC")&&s.push([e-1,t]),t<=4&&this.canEat(e+1,t,"CC")&&s.push([e+1,t]),s.filter((e=>e[0]>=1&&e[0]<=8&&e[1]>=1&&e[1]<=8))}static moveCCC(e,t){let s=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1]])for(let o=1;o<=8;o++){let C=e+i[0]*o,a=t+i[1]*o;if(C<1||C>8||a<1||a>8)break;if(this.isBlock(C,a)&&this.canEat(C,a,"CC")){s.push([C,a]);break}if(!this.isEmpty(C,a)){if(this.canEat(C,a,"CC")){s.push([C,a]);break}break}s.push([C,a])}return s.filter((e=>e[0]>=1&&e[0]<=8&&e[1]>=1&&e[1]<=8))}static moveCCM(e,t){let s=[];return this.isEmpty(e,t-1)&&this.canEat(e+1,t-2,"CC")&&s.push([e+1,t-2]),this.isEmpty(e,t-1)&&this.canEat(e-1,t-2,"CC")&&s.push([e-1,t-2]),this.isEmpty(e+1,t)&&this.canEat(e+2,t-1,"CC")&&s.push([e+2,t-1]),this.isEmpty(e-1,t)&&this.canEat(e-2,t-1,"CC")&&s.push([e-2,t-1]),this.isEmpty(e,t+1)&&this.canEat(e+1,t+2,"CC")&&s.push([e+1,t+2]),this.isEmpty(e,t+1)&&this.canEat(e-1,t+2,"CC")&&s.push([e-1,t+2]),this.isEmpty(e+1,t)&&this.canEat(e+2,t+1,"CC")&&s.push([e+2,t+1]),this.isEmpty(e-1,t)&&this.canEat(e-2,t+1,"CC")&&s.push([e-2,t+1]),s.filter((e=>e[0]>=1&&e[0]<=8&&e[1]>=1&&e[1]<=8))}static moveCCP(e,t){let s=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1]])for(let o=1;o<=8;o++){let C=e+i[0]*o,a=t+i[1]*o;if(C<1||C>8||a<1||a>8)break;if(this.isBlock(C,a)&&this.isEmpty(C,a)){s.push([C,a]);break}if(!this.isEmpty(C,a))break;s.push([C,a])}for(let i=1;i<=8;i++)for(let o=1;o<=8;o++){if(this.isEmpty(i,o))continue;if(!this.canEat(i,o,"CC"))continue;let C=GameManager.getChessByPos(i,o),a=Math.min(e,i),n=Math.max(e,i),r=Math.min(t,o),g=Math.max(t,o),m=0;if(i==e){for(let t=r+1;t<g;t++)1!=e&&8!=e||6!=t||(m=1/0),this.isEmpty(i,t)||m++;1==m&&s.push([i,o])}if(o==t){for(let e=a+1;e<n;e++)this.isEmpty(e,o)||m++;1==m&&s.push([i,o])}if(i!=e&&o!=t){if(!C.moved)continue;let e=(g-r)/(n-a);for(let t=1;t<n-a;t++){if(!Number.isInteger(e*t))continue;let s=a+t,i=r+e*t;this.isEmpty(s,i)||m++}1==m&&s.push([i,o])}}return s.filter((e=>e[0]>=1&&e[0]<=8&&e[1]>=1&&e[1]<=8))}static moveICS(e,t){let s=[];return this.isEmpty(e,t+1)&&s.push([e,t+1]),!this.isEmpty(e-1,t+1)&&this.canEat(e-1,t+1,"IC")&&s.push([e-1,t+1]),!this.isEmpty(e+1,t+1)&&this.canEat(e+1,t+1,"IC")&&s.push([e+1,t+1]),2==t&&this.isEmpty(e,t+1)&&this.isEmpty(e,t+2)&&s.push([e,t+2]),s.filter((e=>e[0]>=1&&e[0]<=8&&e[1]>=1&&e[1]<=8))}}document.addEventListener("DOMContentLoaded",(()=>ImgManager.loadImgs(GameManager.setup.bind(GameManager)))),window.addEventListener("resize",GameManager.setSize.bind(GameManager));